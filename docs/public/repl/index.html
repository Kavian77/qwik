<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Qwik Repl Result App</title>
    <script type="module">
      const init = () => {
        for (let i = 0; i < document.head.children.length; i++) {
          document.head.children[i].setAttribute('data-repl', '');
        }

        const updateAppHtml = (html) => {
          emptyDocument();

          const div = document.createElement('div');
          html = html.replace(/\<html/gi, '<tmp-html');
          html = html.replace(/\<\/html/gi, '</tmp-html');
          html = html.replace(/\<head/gi, '<tmp-head');
          html = html.replace(/\<\/head/gi, '</tmp-head');
          html = html.replace(/\<body/gi, '<tmp-body');
          html = html.replace(/\<\/body/gi, '</tmp-body');
          div.innerHTML = html;

          const updatedDocElement = div.querySelector('tmp-html');
          if (updatedDocElement) {
            cloneAttributes(updatedDocElement, document.documentElement);
          }

          const updatedHead = div.querySelector('tmp-head');
          if (updatedHead) {
            cloneAttributes(updatedHead, document.head);
            cloneNodes(updatedHead, document.head);
          }

          const updateBody = div.querySelector('tmp-body');
          if (updateBody) {
            cloneAttributes(updateBody, document.body);
            cloneNodes(updateBody, document.body);
          }
        };

        const emptyDocument = () => {
          for (let i = document.head.children.length - 1; i >= 0; i--) {
            if (!document.head.children[i].hasAttribute('data-repl')) {
              document.head.remove(document.head.children[i]);
            }
          }

          removeAttributes(document.documentElement);
          removeAttributes(document.head);
          removeAttributes(document.body);

          document.body.innerHTML = '';
        };

        const cloneNodes = (src, dest) => {
          for (let i = 0; i < src.childNodes.length; i++) {
            const srcNode = src.childNodes[i];
            if (srcNode.nodeName === 'SCRIPT') {
              const scriptElm = document.createElement('script');
              scriptElm.innerHTML = srcNode.innerHTML;
              cloneAttributes(srcNode, scriptElm);
              dest.appendChild(scriptElm);
            } else {
              dest.appendChild(srcNode.cloneNode());
            }
          }
        };

        const removeAttributes = (elm) => {
          for (let i = 0; i < elm.attributes.length; i++) {
            elm.removeAttribute(elm.attributes[i].nodeName);
          }
        };

        const cloneAttributes = (src, dest) => {
          for (let i = 0; i < src.attributes.length; i++) {
            dest.setAttribute(src.attributes[i].nodeName, src.attributes[i].nodeValue);
          }
        };

        const updateApp = (data) => {
          updateAppHtml(data.html);
        };

        const receiveMessageFromSw = (ev) => {
          const evData = ev.data;
          const evType = evData && evData.type;
          if (evType === 'result') {
            updateApp(evData);
          }
        };

        let swRegistration = null;
        window.addEventListener('message', (ev) => {
          if (swRegistration.active) {
            const evData = ev.data || {};
            evData.location = location.href;
            swRegistration.active.postMessage(evData);
          }
        });

        navigator.serviceWorker
          .register('/repl/sw.js', {
            scope: '/repl/',
          })
          .then(
            (reg) => {
              swRegistration = reg;
              if (swRegistration.active) {
                navigator.serviceWorker.addEventListener('message', receiveMessageFromSw);
                window.parent.postMessage({ type: 'resultAppReady' }, '*');
              } else if (swRegistration.installing) {
                swRegistration.installing.addEventListener('statechange', (ev) => {
                  if (ev.target.state == 'activated') {
                    navigator.serviceWorker.addEventListener('message', receiveMessageFromSw);
                    window.parent.postMessage({ type: 'resultAppReady' }, '*');
                  }
                });
              }
            },
            (err) => {
              console.log('Repl Service worker registration failed:', err);
            }
          );
      };

      if (document.readyState === 'complete' || document.readyState === 'interactive') {
        init();
      } else {
        window.addEventListener('DOMContentLoaded', init);
      }
    </script>
  </head>
  <body></body>
</html>
